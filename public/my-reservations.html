<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mis reservaciones â€” HabitApp</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-site">

<header class="site-header py-3 shadow-sm">
    <nav class="container d-flex align-items-center">
        <a class="navbar-brand d-flex align-items-center" href="/" aria-label="HabitApp - Inicio">
            <img src="/multimedia/tizihause.jpg" alt="HabitApp logo" class="brand-img me-2">
        </a>
        <div id="headerActions" class="ms-auto d-flex align-items-center gap-2">
            <a href="/login.html" id="loginBtnHeader" class="btn btn-outline-secondary btn-sm rounded-circle"
               title="Iniciar sesiÃ³n">ðŸ‘¤</a>
        </div>
    </nav>
</header>

<main class="container py-4">
    <h1 class="h4 mb-3">Mis reservaciones</h1>
    <p class="text-muted small mb-4">
        AquÃ­ puedes consultar el estado de tus reservaciones, ver los detalles y cancelar cuando sea posible.
    </p>

    <div id="reservationsContainer" class="card shadow-sm">
        <div class="card-body">
            <div id="noReservations" class="alert alert-info d-none">
                AÃºn no tienes reservaciones registradas.
            </div>

            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0 d-none" id="reservationsTable">
                    <thead>
                    <tr>
                        <th>ID Reserva</th>
                        <th>Folio pago</th>
                        <th>Monto</th>
                        <th>Periodo</th>
                        <th>UbicaciÃ³n</th>
                        <th>Estado</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                    </thead>
                    <tbody id="reservationsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<footer class="footer py-4 bg-white mt-5 border-top">
    <div class="container d-flex justify-content-between small text-muted">
        <div>Â© <span id="year-index"></span> HabitApp</div>
        <div>Mis reservaciones</div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // AÃ±o en footer
    document.addEventListener('DOMContentLoaded', () => {
        const y = new Date().getFullYear();
        const el = document.getElementById('year-index');
        if (el) el.textContent = y;
    });

    // Mismo header dinÃ¡mico que en index, pero con "Mis reservaciones"
    (function () {
        async function updateHeader() {
            const container = document.getElementById('headerActions');
            if (!container) return;
            try {
                const res = await fetch('/api/auth/me', { credentials: 'same-origin' });
                if (!res.ok) {
                    return;
                }
                const data = await res.json().catch(() => ({}));
                const user = data && (data.user || data);
                if (!user) return;

                let avatarUrl = user.foto_url || user.fotoUrl || user.avatar || user.foto || (user.user && (user.user.foto_url || user.user.fotoUrl));
                if (avatarUrl && !(avatarUrl.startsWith('/') || /^https?:\/\//i.test(avatarUrl))) {
                    avatarUrl = '/' + avatarUrl;
                }

                const displayName = user.nombre_completo || user.nombre || user.email || 'Usuario';
                const avatarHtml = avatarUrl
                    ? `<img src="${String(avatarUrl).replace(/"/g, '%22')}" alt="avatar" class="header-avatar">`
                    : `<span class="header-avatar bg-secondary d-inline-block" style="display:inline-block;text-align:center;line-height:32px;color:#fff">ðŸ‘¤</span>`;

                const roles = Array.isArray(user.roles) ? user.roles : [];
                const isHost = roles.includes('anfitrion');
                const isGuest = roles.includes('huesped') || isHost;

                container.innerHTML = `
          <div class="d-flex align-items-center gap-2">
            ${avatarHtml}
            <span class="d-none d-md-inline">${String(displayName).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}</span>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="headerMenuBtn"
                      data-bs-toggle="dropdown" data-bs-offset="0,8" aria-expanded="false" aria-label="MenÃº de usuario">â˜°
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="headerMenuBtn">
                <li><a class="dropdown-item" href="/profile_edit.html">Perfil</a></li>
                ${isHost ? `<li><a class="dropdown-item" href="/host/host-dashboard.html">Panel de AnfitriÃ³n</a></li>` : ''}
                ${isGuest ? `<li><a class="dropdown-item" href="/my-reservations.html">Mis reservaciones</a></li>` : ''}
                <li><hr class="dropdown-divider"></li>
                <li><button id="headerLogoutBtn" class="dropdown-item text-danger">Cerrar sesiÃ³n</button></li>
              </ul>
            </div>
          </div>
        `;

                const logoutBtn = document.getElementById('headerLogoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const confirmed = confirm('Â¿Deseas cerrar sesiÃ³n?');
                        if (!confirmed) return;
                        try {
                            const resLogout = await fetch('/api/auth/logout', {
                                method: 'POST',
                                credentials: 'same-origin',
                            });
                            if (!resLogout.ok) {
                                const err = await resLogout.json().catch(() => ({}));
                                alert(err.error || 'No se pudo cerrar sesiÃ³n');
                                return;
                            }
                            try {
                                sessionStorage.removeItem('user_id');
                                sessionStorage.removeItem('user_name');
                                sessionStorage.removeItem('host_id');
                            } catch (e) {}
                            window.location.href = '/login.html';
                        } catch (err) {
                            console.error('logout error', err);
                            alert('Error al cerrar sesiÃ³n');
                        }
                    });
                }
            } catch (err) {
                console.warn('updateHeader error', err);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateHeader);
        } else {
            updateHeader();
        }
    })();
</script>

<script src="/js/my-reservations.js" defer></script>

<style>
    #headerActions .header-avatar {
        height: 32px;
        width: 32px;
        border-radius: 50%;
        object-fit: cover;
        display: inline-block;
    }
</style>
</body>
</html>
